<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰å’Šç™¾è²¨ç”Ÿæ´»é¤¨ - Join Home Supermarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --- å“ç‰Œè¦–è¦ºè¨­å®š (ä¾ç…§æ‚¨çš„æ‹›ç‰Œè¨­è¨ˆ) --- */
        :root {
            --brand-green: #1e7847; /* æ‹›ç‰Œæ·±ç¶  */
            --brand-bg: #fdfdf5;    /* æ‹›ç‰Œç±³è‰²åº• */
            --brand-text: #333;
            --brand-orange: #e47f3f; /* æ‹›ç‰Œæ©˜è‰²é»ç¶´ */
        }
        body { background-color: var(--brand-bg); padding-bottom: 120px; font-family: "Helvetica Neue", Arial, sans-serif; color: var(--brand-text); }
        
        /* Header */
        .header { background-color: var(--brand-bg); border-bottom: 4px solid var(--brand-green); padding: 15px 10px; text-align: center; }
        .logo-img { max-height: 80px; width: auto; display: block; margin: 0 auto 10px auto; } 
        
        /* èªè¨€é¸å–® */
        .lang-select { max-width: 200px; margin: 0 auto; border: 2px solid var(--brand-green); color: var(--brand-green); font-weight: bold; border-radius: 20px; text-align: center; }

        /* å•†å“å¡ç‰‡ */
        .product-card { border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 15px; background: white; border-radius: 15px; overflow: hidden; display: flex; flex-direction: row; align-items: center; }
        
        /* åœ–ç‰‡å€åŸŸ */
        .product-img-box { width: 120px; height: 120px; flex-shrink: 0; background: #eee; position: relative; overflow: hidden; cursor: zoom-in; }
        .product-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .product-img-box:active .product-img { transform: scale(1.1); }

        /* è³‡è¨Šå€åŸŸ */
        .product-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; height: 120px; }
        .product-name { font-weight: bold; font-size: 1.05rem; color: #222; margin-bottom: 2px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .product-subname { font-size: 0.85rem; color: #888; margin-bottom: auto; }
        
        /* åƒ¹æ ¼èˆ‡æŒ‰éˆ• */
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .product-price { color: #e63946; font-weight: bold; font-size: 1.25rem; }
        
        .qty-control { display: flex; align-items: center; background: #f0f0f0; border-radius: 20px; padding: 2px 8px; }
        .qty-btn { width: 28px; height: 28px; border: none; background: white; border-radius: 50%; color: var(--brand-green); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
        .qty-val { width: 30px; text-align: center; font-weight: bold; font-size: 1rem; color: #333; }

        /* åº•éƒ¨çµå¸³å€ */
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 1000; border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .form-control { background-color: #f9f9f9; border: 1px solid #ddd; margin-bottom: 8px; border-radius: 8px; }
        .btn-checkout { background-color: var(--brand-green); border: none; padding: 12px; font-size: 1.1rem; width: 100%; border-radius: 10px; font-weight: bold; box-shadow: 0 4px 10px rgba(30, 120, 71, 0.3); }
        .btn-checkout:active { transform: scale(0.98); }

        /* ç‡ˆç®± */
        .lightbox-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); }
        .lightbox-content-wrapper { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; }
        .lightbox-img { max-width: 95%; max-height: 80vh; border-radius: 8px; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; background: rgba(0,0,0,0.5); width: 50px; height: 50px; text-align: center; line-height: 45px; border-radius: 50%; }
    </style>
</head>
<body>

<div class="header">
    <img src="logo.jpg" alt="å˜‰å’Šç™¾è²¨" class="logo-img" onerror="this.style.display='none'">
    
    <select id="lang-switch" class="form-select lang-select" onchange="switchLang(this.value)">
        <option value="zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
        <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
    </select>
</div>

<div class="container mt-3">
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-success" role="status"></div>
        <div class="mt-2 text-muted">Loading products...</div>
    </div>
    <div id="product-list"></div>
</div>

<div id="imgLightbox" class="lightbox-modal" onclick="closeLightbox()">
    <div class="lightbox-close">&times;</div>
    <div class="lightbox-content-wrapper">
        <img class="lightbox-img" id="lightboxImg">
    </div>
</div>

<div class="cart-bar">
    <div id="checkout-form" style="display:none;">
        <div class="row g-2">
            <div class="col-4"><input type="text" class="form-control" id="cust-name" placeholder="Name"></div>
            <div class="col-4"><input type="tel" class="form-control" id="cust-phone" placeholder="Phone"></div>
            <div class="col-4"><input type="text" class="form-control" id="cust-line" placeholder="LINE ID"></div>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
            <div class="text-muted small">Cart: <span class="badge bg-secondary rounded-pill" id="cart-count">0</span></div>
            <div class="fw-bold fs-4 text-success">$<span id="total-price">0</span></div>
        </div>
        <div style="width: 50%;">
            <button onclick="submitOrder()" class="btn btn-success text-white btn-checkout" id="btn-submit">Checkout</button>
        </div>
    </div>
</div>

<script>
    // =========================================================
    // è¨­å®šå€
    // =========================================================
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRUuy3yndWvFJqQGIZ0oXiWDLjbYzOzZGK6DN1WPz6yExBiAGLZifNvJxvrxyfvjpN7H22qmwqujOkM/pub?gid=0&single=true&output=csv'; 
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbySfQr-1oxCQPVaCRQMKoJSlPhigsUryAMWDnISiWQhC38XoDkfUZwg129FTGY1Na5LSQ/exec';
    // =========================================================

    let products = [];
    let cart = {};
    let currentLang = 'zh';

    const uiText = {
        zh: { name: "å§“å", phone: "é›»è©±", line: "LINE ID", btn: "ç¢ºèªä¸‹å–®", empty: "è³¼ç‰©è»Šæ˜¯ç©ºçš„" },
        en: { name: "Your Name", phone: "Phone", line: "LINE ID", btn: "Place Order", empty: "Cart is empty" },
        id: { name: "Nama", phone: "Nomor HP", line: "ID LINE", btn: "Pesan Sekarang", empty: "Keranjang kosong" },
        vi: { name: "TÃªn", phone: "Sá»‘ Ä‘iá»‡n thoáº¡i", line: "ID LINE", btn: "Äáº·t hÃ ng", empty: "Giá» hÃ ng trá»‘ng" }
    };

    window.onload = function() {
        fetch(csvUrl)
            .then(res => res.text())
            .then(text => {
                products = parseCSV(text);
                renderProducts();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('checkout-form').style.display = 'block';
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading').innerHTML = 'âŒ Loading Error. Please check Google Sheet links.';
            });
    };

    // è‡ªå‹•è½‰æ› Google Drive é€£çµç‚ºå¯è®€åœ–ç‰‡
    function convertDriveLink(link) {
        if (!link) return '';
        // å¦‚æœæ˜¯ Google Drive çš„åˆ†äº«é€£çµ (d/XXX/view)
        if (link.includes('drive.google.com') && link.includes('/d/')) {
            const idMatch = link.match(/\/d\/(.*?)\//);
            if (idMatch && idMatch[1]) {
                return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
            }
        }
        return link;
    }

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const result = [];
        // å¼·åˆ¶æª¢æŸ¥æ¨™é¡Œåˆ—ï¼Œè‡ªå‹•å°æ‡‰æ¬„ä½é †åº
        // é è¨­é †åº: name_zh(0), name_en(1), name_id(2), name_vi(3), price(4), img(5)
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(row && row.length >= 5) {
                const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : '';
                
                result.push({
                    id: i,
                    zh: clean(row[0]),
                    en: clean(row[1]),
                    id_lang: clean(row[2]),
                    vi: clean(row[3]),
                    price: parseInt(clean(row[4])) || 0,
                    img: convertDriveLink(clean(row[5])) // è‡ªå‹•è½‰æ›åœ–ç‰‡é€£çµ
                });
            }
        }
        return result;
    }

    function switchLang(lang) {
        currentLang = lang;
        const t = uiText[lang];
        document.getElementById('cust-name').placeholder = t.name;
        document.getElementById('cust-phone').placeholder = t.phone;
        document.getElementById('cust-line').placeholder = t.line;
        document.getElementById('btn-submit').innerText = t.btn;
        renderProducts();
    }

    function renderProducts() {
        const list = document.getElementById('product-list');
        let html = '';
        products.forEach(p => {
            if(!p.zh) return;
            
            // èªè¨€é¡¯ç¤ºé‚è¼¯ï¼šå¦‚æœè©²èªè¨€æ¬„ä½æ˜¯ç©ºçš„ï¼Œå°±é¡¯ç¤ºè‹±æ–‡æˆ–ä¸­æ–‡
            let mainName = p.zh;
            if (currentLang === 'en' && p.en) mainName = p.en;
            if (currentLang === 'id' && p.id_lang) mainName = p.id_lang;
            if (currentLang === 'vi' && p.vi) mainName = p.vi;
            
            // å‰¯æ¨™é¡Œï¼šå¦‚æœæ˜¯å¤–æ–‡æ¨¡å¼ï¼Œé¡¯ç¤ºä¸­æ–‡åŸå
            let subName = (currentLang !== 'zh') ? p.zh : '';
            
            // åœ–ç‰‡
            let imgSrc = (p.img && p.img.startsWith('http')) ? p.img : 'https://placehold.co/150x150/eee/999?text=No+Image';
            let qty = cart[p.zh] ? cart[p.zh].qty : 0;

            html += `
            <div class="product-card">
                <div class="product-img-box" onclick="openLightbox('${imgSrc}')">
                    <img src="${imgSrc}" class="product-img">
                </div>
                <div class="product-info">
                    <div>
                        <div class="product-name">${mainName}</div>
                        ${subName ? `<div class="product-subname">${subName}</div>` : ''}
                    </div>
                    <div class="price-row">
                        <span class="product-price">$${p.price}</span>
                        <div class="qty-control">
                            <button onclick="updateQty('${p.zh}', ${p.price}, -1)" class="qty-btn">-</button>
                            <div class="qty-val">${qty}</div>
                            <button onclick="updateQty('${p.zh}', ${p.price}, 1)" class="qty-btn">+</button>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    }

    function updateQty(nameZh, price, change) {
        if (change === 1 && !cart[nameZh]) {
            cart[nameZh] = { price: price, qty: 1 };
        } else if (cart[nameZh]) {
            cart[nameZh].qty += change;
            if (cart[nameZh].qty <= 0) delete cart[nameZh];
        }
        renderProducts();
        updateCartTotal();
    }

    function updateCartTotal() {
        let total = 0, count = 0;
        for(let k in cart) {
            total += cart[k].price * cart[k].qty;
            count += cart[k].qty;
        }
        document.getElementById('total-price').innerText = total;
        document.getElementById('cart-count').innerText = count;
    }

    // ç‡ˆç®±
    function openLightbox(src) {
        const modal = document.getElementById('imgLightbox');
        document.getElementById('lightboxImg').src = src;
        modal.style.display = 'block';
    }
    function closeLightbox() {
        document.getElementById('imgLightbox').style.display = 'none';
    }

    // é€å‡ºè¨‚å–®
    function submitOrder() {
        const name = document.getElementById('cust-name').value.trim();
        const phone = document.getElementById('cust-phone').value.trim();
        const line = document.getElementById('cust-line').value.trim();
        const total = document.getElementById('total-price').innerText;
        const t = uiText[currentLang];

        if(Object.keys(cart).length === 0) return alert(t.empty);
        if(!name || !phone) return alert(currentLang==='zh' ? 'è«‹å¡«å¯«å§“åå’Œé›»è©±' : 'Please fill in Name and Phone');

        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.innerText = 'Sending...';

        let details = '';
        for(let k in cart) {
            details += `${k} x${cart[k].qty}, `;
        }

        const formData = new FormData();
        formData.append('å§“å', name);
        formData.append('é›»è©±', phone);
        formData.append('LINE_ID', line);
        formData.append('è¨‚å–®å…§å®¹', details);
        formData.append('ç¸½é‡‘é¡', total);

        fetch(scriptUrl, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    alert('âœ… è¨‚å–®å·²é€å‡º / Order Sent!');
                    cart = {};
                    document.getElementById('cust-name').value = '';
                    document.getElementById('cust-phone').value = '';
                    renderProducts();
                    updateCartTotal();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => alert('Network Error'))
            .finally(() => {
                btn.disabled = false;
                btn.innerText = t.btn;
            });
    }
</script>

</body>
</html>