<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å˜‰å’Šç™¾è²¨ç”Ÿæ´»é¤¨ - Join Home Supermarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --- å“ç‰Œè¦–è¦º --- */
        :root {
            --brand-green: #1e7847;
            --brand-bg: #fdfdf5;
            --brand-text: #333;
            --brand-orange: #e47f3f;
        }
        body { background-color: var(--brand-bg); padding-bottom: 120px; font-family: "Helvetica Neue", Arial, sans-serif; color: var(--brand-text); }
        
        /* é é¦– Header */
        .header { background-color: white; padding: 10px 15px; position: sticky; top: 0; z-index: 1020; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .logo-img { height: 40px; width: auto; } 
        
        .lang-select { border: 1px solid var(--brand-green); color: var(--brand-green); font-weight: bold; border-radius: 20px; font-size: 0.85rem; padding: 2px 10px; cursor: pointer; background: white; }

        /* --- åˆ†é¡å°è¦½åˆ— (é¡ä¼¼å¤–é€å¹³å°) --- */
        .category-nav { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .category-nav::-webkit-scrollbar { display: none; }
        .cat-btn { white-space: nowrap; padding: 6px 15px; border-radius: 20px; background: #f1f1f1; color: #666; font-size: 0.9rem; border: none; transition: 0.3s; }
        .cat-btn.active { background: var(--brand-green); color: white; font-weight: bold; }

        /* åˆ†é¡æ¨™é¡Œ */
        .category-title { font-weight: bold; font-size: 1.1rem; margin: 20px 0 10px 0; color: var(--brand-green); border-left: 4px solid var(--brand-orange); padding-left: 10px; scroll-margin-top: 140px; }

        /* å•†å“å¡ç‰‡ */
        .product-card { background: white; border-radius: 12px; padding: 10px; margin-bottom: 15px; display: flex; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
        
        /* åœ–ç‰‡å€åŸŸ */
        .product-img-box { width: 100px; height: 100px; flex-shrink: 0; border-radius: 8px; overflow: hidden; position: relative; background: #f8f9fa; }
        .product-img { width: 100%; height: 100%; object-fit: cover; }
        
        /* è³‡è¨Šå€åŸŸ */
        .product-info { flex-grow: 1; padding-left: 12px; display: flex; flex-direction: column; justify-content: space-between; }
        .product-name { font-weight: bold; font-size: 1rem; color: #333; line-height: 1.3; margin-bottom: 2px; }
        .product-subname { font-size: 0.8rem; color: #999; }
        .product-price { color: #e63946; font-weight: bold; font-size: 1.1rem; }
        
        /* åŠ æ¸›æŒ‰éˆ• */
        .add-btn { width: 30px; height: 30px; background: var(--brand-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; position: absolute; right: 10px; bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .qty-control { display: flex; align-items: center; position: absolute; right: 10px; bottom: 10px; background: white; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .qty-btn { width: 30px; height: 30px; border: none; background: transparent; color: var(--brand-green); font-weight: bold; font-size: 1.2rem; }
        .qty-val { width: 25px; text-align: center; font-weight: bold; font-size: 0.9rem; }

        /* åº•éƒ¨çµå¸³å€ */
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 1030; border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .btn-checkout { background-color: var(--brand-green); border: none; padding: 12px; font-size: 1.1rem; width: 100%; border-radius: 10px; font-weight: bold; }
        
        /* ç‡ˆç®± */
        .lightbox-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .lightbox-img { max-width: 95%; max-height: 80vh; border-radius: 8px; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-top">
        <div class="d-flex align-items-center">
            <img src="logo.jpg" alt="Logo" class="logo-img" onerror="this.style.display='none'">
            <span class="ms-2 fw-bold" style="color:var(--brand-green)">å˜‰å’Šç™¾è²¨</span>
        </div>
        <select id="lang-switch" class="lang-select" onchange="switchLang(this.value)">
            <option value="zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</option>
            <option value="en">ğŸ‡ºğŸ‡¸ English</option>
            <option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
            <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
        </select>
    </div>
    <div class="category-nav" id="cat-nav"></div>
</div>

<div class="container mt-2">
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-success" role="status"></div>
        <div class="mt-2 text-muted">æ­£åœ¨æ•´ç†è²¨æ¶...</div>
    </div>
    <div id="product-container"></div>
</div>

<div id="imgLightbox" class="lightbox-modal" onclick="this.style.display='none'">
    <img class="lightbox-img" id="lightboxImg">
</div>

<div class="cart-bar">
    <div id="checkout-form" style="display:none;" class="mb-2">
        <div class="row g-2">
            <div class="col-4"><input type="text" class="form-control form-control-sm" id="cust-name" placeholder="Name"></div>
            <div class="col-4"><input type="tel" class="form-control form-control-sm" id="cust-phone" placeholder="Phone"></div>
            <div class="col-4"><input type="text" class="form-control form-control-sm" id="cust-line" placeholder="LINE ID"></div>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <div class="text-muted small">Cart: <span class="badge bg-secondary rounded-pill" id="cart-count">0</span></div>
            <div class="fw-bold fs-4 text-success">$<span id="total-price">0</span></div>
        </div>
        <div style="width: 50%;">
            <button onclick="submitOrder()" class="btn btn-success text-white btn-checkout" id="btn-submit">Checkout</button>
        </div>
    </div>
</div>

<script>
    // =========================================================
    // è¨­å®šå€
    // =========================================================
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRUuy3yndWvFJqQGIZ0oXiWDLjbYzOzZGK6DN1WPz6yExBiAGLZifNvJxvrxyfvjpN7H22qmwqujOkM/pub?gid=0&single=true&output=csv'; 
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbySfQr-1oxCQPVaCRQMKoJSlPhigsUryAMWDnISiWQhC38XoDkfUZwg129FTGY1Na5LSQ/exec';
    // =========================================================

    let products = [];
    let cart = {};
    let currentLang = 'zh';

    const uiText = {
        zh: { name: "å§“å", phone: "é›»è©±", line: "LINE ID", btn: "ç¢ºèªä¸‹å–®", empty: "è³¼ç‰©è»Šæ˜¯ç©ºçš„" },
        en: { name: "Name", phone: "Phone", line: "LINE ID", btn: "Order", empty: "Cart Empty" },
        id: { name: "Nama", phone: "HP", line: "LINE ID", btn: "Pesan", empty: "Keranjang Kosong" },
        vi: { name: "TÃªn", phone: "SÄT", line: "LINE ID", btn: "Äáº·t HÃ ng", empty: "Giá» HÃ ng Trá»‘ng" }
    };

    window.onload = function() {
        fetch(csvUrl)
            .then(res => res.text())
            .then(text => {
                products = parseCSV(text);
                renderApp();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('checkout-form').style.display = 'block';
            })
            .catch(err => alert('è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–è©¦ç®—è¡¨è¨­å®š'));
    };

    // å¼·åŠ›åœ–ç‰‡ä¿®å¾©
    function fixImgUrl(url) {
        if (!url) return '';
        if (url.includes('drive.google.com')) {
            let id = '';
            let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
            if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
        }
        return url;
    }

    // æ™ºæ…§ CSV è§£æ (åŒ…å«åˆ†é¡ category)
    function parseCSV(text) {
        const lines = text.trim().split('\n');
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
        
        // æ¬„ä½å°æ‡‰
        const idx = {
            cat: headers.indexOf('category'), // æ–°å¢åˆ†é¡æ¬„ä½
            zh: headers.indexOf('name_zh'),
            en: headers.indexOf('name_en'),
            id: headers.indexOf('name_id'),
            vi: headers.indexOf('name_vi'),
            price: headers.indexOf('price'),
            img: headers.indexOf('img')
        };

        const result = [];
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(row) {
                const clean = (colIndex) => (colIndex > -1 && row[colIndex]) ? row[colIndex].replace(/^"|"$/g, '').trim() : '';
                
                let p = {
                    id: i,
                    category: clean(idx.cat) || "å…¶ä»–å•†å“ (Others)", // é è¨­åˆ†é¡
                    zh: clean(idx.zh),
                    en: clean(idx.en),
                    id_lang: clean(idx.id),
                    vi: clean(idx.vi),
                    price: parseInt(clean(idx.price)) || 0,
                    img: fixImgUrl(clean(idx.img))
                };
                if(p.zh && p.price) result.push(p);
            }
        }
        return result;
    }

    function switchLang(lang) {
        currentLang = lang;
        const t = uiText[lang];
        document.getElementById('cust-name').placeholder = t.name;
        document.getElementById('cust-phone').placeholder = t.phone;
        document.getElementById('cust-line').placeholder = t.line;
        document.getElementById('btn-submit').innerText = t.btn;
        renderApp(); // é‡æ–°æ¸²æŸ“æ•´å€‹ä»‹é¢ (å«åˆ†é¡ç¿»è­¯)
    }

    function renderApp() {
        const container = document.getElementById('product-container');
        const nav = document.getElementById('cat-nav');
        container.innerHTML = '';
        nav.innerHTML = '';

        // 1. æ•´ç†åˆ†é¡
        let categories = [...new Set(products.map(p => p.category))];
        
        // 2. å»ºç«‹åˆ†é¡é¸å–®
        categories.forEach((cat, index) => {
            nav.innerHTML += `<button class="cat-btn ${index===0?'active':''}" onclick="scrollToCat('${cat}', this)">${cat}</button>`;
            
            // 3. å»ºç«‹å•†å“å€å¡Š
            let catProducts = products.filter(p => p.category === cat);
            let productHTML = '';
            
            catProducts.forEach(p => {
                let mainName = p.zh;
                if (currentLang === 'en' && p.en) mainName = p.en;
                if (currentLang === 'id' && p.id_lang) mainName = p.id_lang;
                if (currentLang === 'vi' && p.vi) mainName = p.vi;
                let subName = (currentLang !== 'zh') ? p.zh : '&nbsp;';
                
                let imgSrc = p.img ? p.img : 'https://placehold.co/100x100/eee/ccc?text=No+Img';
                let qty = cart[p.zh] ? cart[p.zh].qty : 0;

                // æ•¸é‡æ§åˆ¶æŒ‰éˆ•é‚è¼¯
                let btnHTML = qty === 0 
                    ? `<div class="add-btn" onclick="updateQty('${p.zh}', ${p.price}, 1)">+</div>`
                    : `<div class="qty-control">
                        <button class="qty-btn" onclick="updateQty('${p.zh}', ${p.price}, -1)">-</button>
                        <div class="qty-val">${qty}</div>
                        <button class="qty-btn" onclick="updateQty('${p.zh}', ${p.price}, 1)">+</button>
                       </div>`;

                productHTML += `
                <div class="product-card">
                    <div class="product-img-box" onclick="showLightbox('${imgSrc}')">
                        <img src="${imgSrc}" class="product-img" onerror="this.src='https://placehold.co/100x100/eee/ccc?text=No+Img'">
                    </div>
                    <div class="product-info">
                        <div>
                            <div class="product-name">${mainName}</div>
                            <div class="product-subname">${subName}</div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="product-price">$${p.price}</div>
                        </div>
                        ${btnHTML}
                    </div>
                </div>`;
            });

            container.innerHTML += `<div id="cat-${cat}" class="category-title">${cat}</div><div>${productHTML}</div>`;
        });
    }

    function scrollToCat(cat, btn) {
        document.getElementById(`cat-${cat}`).scrollIntoView({behavior: 'smooth', block: 'start'});
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function updateQty(nameZh, price, change) {
        if (change === 1 && !cart[nameZh]) cart[nameZh] = { price: price, qty: 1 };
        else if (cart[nameZh]) {
            cart[nameZh].qty += change;
            if (cart[nameZh].qty <= 0) delete cart[nameZh];
        }
        renderApp();
        updateCartTotal();
    }

    function updateCartTotal() {
        let total = 0, count = 0;
        for(let k in cart) {
            total += cart[k].price * cart[k].qty;
            count += cart[k].qty;
        }
        document.getElementById('total-price').innerText = total;
        document.getElementById('cart-count').innerText = count;
    }

    function showLightbox(src) {
        if(src.includes('placehold')) return;
        document.getElementById('lightboxImg').src = src;
        document.getElementById('imgLightbox').style.display = 'flex';
    }

    function submitOrder() {
        const name = document.getElementById('cust-name').value.trim();
        const phone = document.getElementById('cust-phone').value.trim();
        const line = document.getElementById('cust-line').value.trim();
        const total = document.getElementById('total-price').innerText;
        
        if(Object.keys(cart).length === 0) return alert(uiText[currentLang].empty);
        if(!name || !phone) return alert('è«‹å¡«å¯« Name & Phone');

        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.innerText = 'Sending...';

        let details = '';
        for(let k in cart) details += `${k} x${cart[k].qty}, `;

        const formData = new FormData();
        formData.append('å§“å', name);
        formData.append('é›»è©±', phone);
        formData.append('LINE_ID', line);
        formData.append('è¨‚å–®å…§å®¹', details);
        formData.append('ç¸½é‡‘é¡', total);

        fetch(scriptUrl, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    alert('âœ… Order Sent!');
                    cart = {};
                    renderApp();
                    updateCartTotal();
                } else alert('Error: ' + data.error);
            })
            .catch(err => alert('Network Error'))
            .finally(() => {
                btn.disabled = false;
                btn.innerText = uiText[currentLang].btn;
            });
    }
</script>

</body>
</html>