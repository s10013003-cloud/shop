<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰å’Šç™¾è²¨ç”Ÿæ´»é¤¨ - Join Home Supermarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --- å“ç‰Œè¨­å®š --- */
        :root {
            --brand-green: #1e7847;
            --brand-bg: #fdfdf9;
            --brand-text: #333;
        }
        body { background-color: var(--brand-bg); padding-bottom: 120px; font-family: sans-serif; color: var(--brand-text); }
        
        /* Header å€åŸŸ */
        .header { background-color: white; border-bottom: 3px solid var(--brand-green); padding: 15px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-top { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .logo-img { max-height: 60px; width: auto; object-fit: contain; } 
        .header-text h1 { margin: 0; font-size: 1.2rem; font-weight: bold; color: var(--brand-green); }
        .header-text p { margin: 0; font-size: 0.8rem; color: #666; }
        
        /* èªè¨€é¸å–® */
        .lang-select { max-width: 200px; margin: 0 auto; border-color: var(--brand-green); color: var(--brand-green); font-weight: bold; }

        /* å•†å“å¡ç‰‡ */
        .product-card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.04); margin-bottom: 15px; background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: row; }
        
        .product-img-box { width: 110px; height: 110px; flex-shrink: 0; position: relative; background: #eee; cursor: zoom-in; }
        .product-img { width: 100%; height: 100%; object-fit: cover; }
        .zoom-hint { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 0.7rem; padding: 2px 6px; border-top-left-radius: 6px; pointer-events: none; }

        .product-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .product-name { font-weight: bold; font-size: 1rem; margin-bottom: 2px; color: #222; line-height: 1.2; }
        .product-subname { font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .product-price { color: #e63946; font-weight: bold; font-size: 1.2rem; }
        
        /* æ•¸é‡æ§åˆ¶ */
        .qty-control { display: flex; align-items: center; background: #f1f3f5; border-radius: 20px; padding: 2px; }
        .qty-btn { width: 28px; height: 28px; border: none; background: white; border-radius: 50%; color: var(--brand-green); font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .qty-val { width: 25px; text-align: center; font-weight: bold; font-size: 0.9rem; }

        /* åº•éƒ¨çµå¸³å€ */
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 1000; border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .form-control { background-color: #f8f9fa; border: 1px solid #e9ecef; margin-bottom: 8px; font-size: 0.9rem; }
        .btn-checkout { background-color: var(--brand-green); border: none; padding: 10px; font-size: 1rem; width: 100%; border-radius: 8px; }
        
        /* ç‡ˆç®± */
        .lightbox-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); opacity: 0; transition: opacity 0.3s; }
        .lightbox-modal.show { opacity: 1; }
        .lightbox-content-wrapper { display: flex; align-items: center; justify-content: center; height: 100%; }
        .lightbox-img { max-width: 95%; max-height: 80vh; border-radius: 5px; transform: scale(0.9); transition: transform 0.3s; }
        .lightbox-modal.show .lightbox-img { transform: scale(1); }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; z-index: 2001; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-top">
        <img src="logo.jpg" alt="Logo" class="logo-img" onerror="this.style.display='none'">
        <div class="header-text">
            <h1>å˜‰å’Šç™¾è²¨ç”Ÿæ´»é¤¨</h1>
            <p>Join Home Supermarket</p>
        </div>
    </div>
    <select id="lang-switch" class="form-select lang-select" onchange="switchLang(this.value)">
        <option value="zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
        <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
    </select>
</div>

<div class="container mt-4">
    <div id="loading" class="text-center py-5 text-muted">Loading products...</div>
    <div id="product-list"></div>
</div>

<div id="imgLightbox" class="lightbox-modal" onclick="closeLightbox()">
    <div class="lightbox-close">&times;</div>
    <div class="lightbox-content-wrapper">
        <img class="lightbox-img" id="lightboxImg">
    </div>
</div>

<div class="cart-bar">
    <div id="checkout-form" style="display:none;">
        <div class="row g-2">
            <div class="col-4"><input type="text" class="form-control" id="cust-name" placeholder="Name"></div>
            <div class="col-4"><input type="tel" class="form-control" id="cust-phone" placeholder="Phone"></div>
            <div class="col-4"><input type="text" class="form-control" id="cust-line" placeholder="LINE ID"></div>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
            <div class="text-muted small">Cart: <span class="badge bg-secondary rounded-pill" id="cart-count">0</span></div>
            <div class="fw-bold fs-4 text-success">$<span id="total-price">0</span></div>
        </div>
        <div style="width: 50%;">
            <button onclick="submitOrder()" class="btn btn-success fw-bold btn-checkout" id="btn-submit">Checkout</button>
        </div>
    </div>
</div>

<script>
    // =========================================================
    // æ‚¨çš„ç¶²å€ (å·²å¹«æ‚¨è¨­å®šå¥½)
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRUuy3yndWvFJqQGIZ0oXiWDLjbYzOzZGK6DN1WPz6yExBiAGLZifNvJxvrxyfvjpN7H22qmwqujOkM/pub?gid=0&single=true&output=csv'; 
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbySfQr-1oxCQPVaCRQMKoJSlPhigsUryAMWDnISiWQhC38XoDkfUZwg129FTGY1Na5LSQ/exec';
    // =========================================================

    let products = [];
    let cart = {};
    let currentLang = 'zh';

    // ä»‹é¢ç¿»è­¯è¨­å®š
    const uiText = {
        zh: { name: "å§“å", phone: "é›»è©±", line: "LINE ID", btn: "ç¢ºèªä¸‹å–®", empty: "è³¼ç‰©è»Šæ˜¯ç©ºçš„" },
        en: { name: "Your Name", phone: "Phone", line: "LINE ID", btn: "Place Order", empty: "Cart is empty" },
        id: { name: "Nama", phone: "Nomor HP", line: "ID LINE", btn: "Pesan Sekarang", empty: "Keranjang kosong" },
        vi: { name: "TÃªn", phone: "Sá»‘ Ä‘iá»‡n thoáº¡i", line: "ID LINE", btn: "Äáº·t hÃ ng", empty: "Giá» hÃ ng trá»‘ng" }
    };

    window.onload = function() {
        fetch(csvUrl)
            .then(res => res.text())
            .then(text => {
                products = parseCSV(text);
                renderProducts();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('checkout-form').style.display = 'block';
            })
            .catch(err => {
                document.getElementById('loading').innerHTML = 'âŒ Error loading data.<br>Please check Google Sheet columns.';
            });
    };

    // è§£æåŒ…å«å¤šåœ‹èªè¨€çš„ CSV
    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const result = [];
        // å‡è¨­æ¬„ä½é †åº: name_zh, name_en, name_id, name_vi, price, img
        for(let i=1; i<lines.length; i++) {
            const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g); // æ­£å‰‡è™•ç† CSV
            if(row && row.length >= 5) {
                const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : '';
                result.push({
                    id: i,
                    zh: clean(row[0]),
                    en: clean(row[1]),
                    id_lang: clean(row[2]), // id æ˜¯ä¿ç•™å­—ï¼Œæ”¹ç”¨ id_lang
                    vi: clean(row[3]),
                    price: parseInt(clean(row[4])) || 0,
                    img: clean(row[5])
                });
            }
        }
        return result;
    }

    function switchLang(lang) {
        currentLang = lang;
        const t = uiText[lang];
        document.getElementById('cust-name').placeholder = t.name;
        document.getElementById('cust-phone').placeholder = t.phone;
        document.getElementById('cust-line').placeholder = t.line;
        document.getElementById('btn-submit').innerText = t.btn;
        renderProducts();
    }

    function renderProducts() {
        const list = document.getElementById('product-list');
        let html = '';
        products.forEach(p => {
            if(!p.zh) return;
            // æ±ºå®šé¡¯ç¤ºå“ªç¨®èªè¨€
            let mainName = p[currentLang === 'id' ? 'id_lang' : currentLang] || p.zh;
            // é¡¯ç¤ºä¸­æ–‡å‰¯æ¨™é¡Œ (è®“å¤–ç±äººå£«ä¹Ÿèƒ½å°ç…§ï¼Œæˆ–è€é—†çœ‹ç•«é¢æ–¹ä¾¿)
            let subName = (currentLang !== 'zh') ? p.zh : '';
            
            let imgSrc = (p.img && p.img.startsWith('http')) ? p.img : 'https://placehold.co/150x150/eee/999?text=å˜‰å’Š';
            let qty = cart[p.zh] ? cart[p.zh].qty : 0;

            html += `
            <div class="product-card">
                <div class="product-img-box" onclick="openLightbox('${imgSrc}')">
                    <img src="${imgSrc}" class="product-img">
                    <div class="zoom-hint">ğŸ”</div>
                </div>
                <div class="product-info">
                    <div>
                        <div class="product-name">${mainName}</div>
                        ${subName ? `<div class="product-subname">${subName}</div>` : ''}
                    </div>
                    <div class="d-flex justify-content-between align-items-end mt-2">
                        <span class="product-price">$${p.price}</span>
                        <div class="qty-control">
                            <button onclick="updateQty('${p.zh}', ${p.price}, -1)" class="qty-btn">-</button>
                            <div class="qty-val">${qty}</div>
                            <button onclick="updateQty('${p.zh}', ${p.price}, 1)" class="qty-btn">+</button>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    }

    // ä½¿ç”¨ã€Œä¸­æ–‡åç¨±ã€ç•¶ä½œè³¼ç‰©è»Šçš„ Keyï¼Œé€™æ¨£å¾Œå°è¨‚å–®æ‰æœƒæ˜¯ä¸­æ–‡
    function updateQty(nameZh, price, change) {
        if (change === 1 && !cart[nameZh]) {
            cart[nameZh] = { price: price, qty: 1 };
        } else if (cart[nameZh]) {
            cart[nameZh].qty += change;
            if (cart[nameZh].qty <= 0) delete cart[nameZh];
        }
        renderProducts();
        updateCartTotal();
    }

    function updateCartTotal() {
        let total = 0, count = 0;
        for(let k in cart) {
            total += cart[k].price * cart[k].qty;
            count += cart[k].qty;
        }
        document.getElementById('total-price').innerText = total;
        document.getElementById('cart-count').innerText = count;
    }

    // --- ç‡ˆç®± ---
    function openLightbox(src) {
        const modal = document.getElementById('imgLightbox');
        document.getElementById('lightboxImg').src = src;
        modal.style.display = 'block';
        setTimeout(() => modal.classList.add('show'), 10);
    }
    function closeLightbox() {
        const modal = document.getElementById('imgLightbox');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // --- é€å‡ºè¨‚å–® ---
    function submitOrder() {
        const name = document.getElementById('cust-name').value.trim();
        const phone = document.getElementById('cust-phone').value.trim();
        const line = document.getElementById('cust-line').value.trim();
        const total = document.getElementById('total-price').innerText;
        const t = uiText[currentLang];

        if(Object.keys(cart).length === 0) return alert(t.empty);
        if(!name || !phone) return alert(currentLang==='zh' ? 'è«‹å¡«å¯«å§“åå’Œé›»è©±' : 'Please fill in Name and Phone');

        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.innerText = '...';

        let details = '';
        for(let k in cart) {
            details += `${k} x${cart[k].qty}, `;
        }

        const formData = new FormData();
        formData.append('å§“å', name);
        formData.append('é›»è©±', phone);
        formData.append('LINE_ID', line);
        formData.append('è¨‚å–®å…§å®¹', details);
        formData.append('ç¸½é‡‘é¡', total);

        fetch(scriptUrl, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    alert('OK! Order Sent. è¨‚å–®å·²é€å‡º');
                    cart = {};
                    document.getElementById('cust-name').value = '';
                    document.getElementById('cust-phone').value = '';
                    renderProducts();
                    updateCartTotal();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => alert('Network Error'))
            .finally(() => {
                btn.disabled = false;
                btn.innerText = t.btn;
            });
    }
</script>

</body>
</html>