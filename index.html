<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰å’Šç™¾è²¨ - Join Home Supermarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 100px; font-family: sans-serif; }
        .header { background-color: #00C300; color: white; padding: 15px; text-align: center; }
        .lang-select { margin: 10px auto; max-width: 200px; }
        .product-card { border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: row; }
        .product-img { width: 110px; height: 110px; object-fit: cover; background-color: #eee; flex-shrink: 0; }
        .product-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .price { color: #dc3545; font-weight: bold; font-size: 1.1rem; }
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .loading { text-align: center; padding: 50px; color: #666; }
        /* æ•¸é‡èª¿æ•´æŒ‰éˆ• */
        .qty-btn { width: 30px; height: 30px; padding: 0; border-radius: 50%; border: 1px solid #ccc; background: white; color: #333; }
    </style>
</head>
<body>

<div class="header">
    <h4 class="m-0">Join Home Supermarket</h4>
    <select id="lang-switch" class="form-select lang-select" onchange="switchLang(this.value)">
        <option value="zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
        <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
    </select>
</div>

<div class="container mt-3">
    <div id="loading" class="loading">
        Loading products...<br>
        <small style="font-size:0.7rem">(Please wait a moment)</small>
    </div>
    <div id="product-list"></div>
</div>

<div class="cart-bar">
    <div class="mb-2" id="checkout-form" style="display:none;">
        <div class="row g-2">
            <div class="col-6">
                <input type="text" class="form-control form-control-sm" id="cust-name" placeholder="Name">
            </div>
            <div class="col-6">
                <input type="text" class="form-control form-control-sm" id="cust-line" placeholder="LINE ID">
            </div>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
            <span class="badge bg-danger rounded-pill" id="cart-count">0</span> 
            Total: <span class="text-success fw-bold">$<span id="total-price">0</span></span>
        </div>
        <button onclick="checkout()" class="btn btn-success fw-bold btn-sm px-4" id="btn-checkout">LINE Checkout</button>
    </div>
</div>

<script>
    // ==========================================
    // æ‚¨çš„ Google è©¦ç®—è¡¨ CSV é€£çµ (å·²è¨­å®šå¥½)
    const csvUrl = 'https://docs.google.com/spreadsheets/d/1iof8pqZUxkbVUN-g3lNUcHPRxZCyVxfUCcojvbv3URQ/pub?output=csv'; 
    // ==========================================

    let products = [];
    let cart = {};
    let currentLang = 'zh';

    // ä»‹é¢ç¿»è­¯
    const uiText = {
        zh: { namePlace: "å§“å", linePlace: "LINE ID", btn: "ç”¨ LINE çµå¸³" },
        en: { namePlace: "Your Name", linePlace: "LINE ID", btn: "Checkout" },
        id: { namePlace: "Nama Anda", linePlace: "ID LINE", btn: "Beli" },
        vi: { namePlace: "TÃªn cá»§a báº¡n", linePlace: "ID LINE", btn: "Thanh toÃ¡n" }
    };

    window.onload = function() {
        fetch(csvUrl)
            .then(res => res.text())
            .then(text => {
                products = parseCSV(text);
                renderProducts();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('checkout-form').style.display = 'block';
            })
            .catch(err => {
                document.getElementById('loading').innerHTML = 'âŒ Error loading data.<br>Please check Google Sheet "Publish to Web" settings.';
            });
    };

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const result = [];
        // å¾ç¬¬2è¡Œé–‹å§‹è®€å– (å¿½ç•¥æ¨™é¡Œ)
        for(let i=1; i<lines.length; i++) {
            // è™•ç† CSV çš„é€—è™Ÿåˆ†éš” (ç°¡æ˜“ç‰ˆ)
            const row = lines[i].split(',');
            if(row.length >= 5) {
                // ç§»é™¤å¯èƒ½çš„å¼•è™Ÿèˆ‡ç©ºç™½
                const clean = (str) => str ? str.replace(/["\r]/g, '').trim() : '';
                
                result.push({
                    id: i,
                    zh: clean(row[0]), 
                    en: clean(row[1]), 
                    id_lang: clean(row[2]), 
                    vi: clean(row[3]),
                    price: parseInt(clean(row[4])) || 0,
                    img: clean(row[5])
                });
            }
        }
        return result;
    }

    function switchLang(lang) {
        currentLang = lang;
        document.getElementById('cust-name').placeholder = uiText[lang].namePlace;
        document.getElementById('cust-line').placeholder = uiText[lang].linePlace;
        document.getElementById('btn-checkout').innerText = uiText[lang].btn;
        renderProducts();
    }

    function renderProducts() {
        const list = document.getElementById('product-list');
        let html = '';
        products.forEach(p => {
            if(!p.zh) return; // è·³éç©ºè¡Œ
            
            // æ ¹æ“šèªè¨€é¡¯ç¤ºå°æ‡‰åç¨±ï¼Œè‹¥ç„¡ç¿»è­¯å‰‡é¡¯ç¤ºä¸­æ–‡
            let displayName = p[currentLang === 'id' ? 'id_lang' : currentLang] || p.zh;
            let imgSrc = (p.img && p.img.startsWith('http')) ? p.img : 'https://placehold.co/150/eee/999?text=No+Img';
            
            // æª¢æŸ¥è³¼ç‰©è»Šå…§æ•¸é‡
            let qty = cart[p.zh] ? cart[p.zh].qty : 0;

            html += `
            <div class="product-card">
                <img src="${imgSrc}" class="product-img">
                <div class="product-info">
                    <div>
                        <div class="fw-bold text-dark" style="font-size:1rem;">${displayName}</div>
                        ${currentLang !== 'zh' ? `<small class="text-muted">${p.zh}</small>` : ''}
                    </div>
                    <div class="d-flex justify-content-between align-items-end mt-2">
                        <span class="price">$${p.price}</span>
                        
                        <div class="d-flex align-items-center">
                            ${qty > 0 ? `<button onclick="updateQty('${p.zh}', -1)" class="qty-btn">-</button>` : ''}
                            <span class="mx-2 fw-bold ${qty > 0 ? 'text-success' : 'text-muted'}">${qty > 0 ? qty : ''}</span>
                            <button onclick="updateQty('${p.zh}', ${p.price}, 1)" class="btn btn-sm btn-outline-success rounded-pill" style="min-width:30px;">+</button>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    }

    function updateQty(nameZh, price, change) {
        // å¦‚æœæ˜¯æŒ‰åŠ è™Ÿï¼Œä¸”å•†å“é‚„æ²’åœ¨è»Šè£¡ï¼Œå…ˆå‚³å…¥åƒ¹æ ¼
        // å¦‚æœæ˜¯æŒ‰æ¸›è™Ÿï¼Œåªå‚³ nameZh å’Œ change å°±å¤ äº†
        if(change === 1 && !cart[nameZh]) {
            cart[nameZh] = { price: price, qty: 1 };
        } else if (cart[nameZh]) {
            cart[nameZh].qty += change;
            if(cart[nameZh].qty <= 0) delete cart[nameZh];
        }
        
        // é‡æ–°æ¸²æŸ“ç•«é¢ (ç‚ºäº†æ›´æ–° + - æŒ‰éˆ•ç‹€æ…‹)
        renderProducts();
        updateCartTotal();
    }

    function updateCartTotal() {
        let total = 0, count = 0;
        for(let k in cart) {
            total += cart[k].price * cart[k].qty;
            count += cart[k].qty;
        }
        document.getElementById('total-price').innerText = total;
        document.getElementById('cart-count').innerText = count;
    }

    function checkout() {
        const name = document.getElementById('cust-name').value;
        const line = document.getElementById('cust-line').value;
        
        if(Object.keys(cart).length === 0) return alert('Cart is empty!');
        if(!name) return alert('Please enter your name.');

        let msg = `ã€è¨‚å–® New Orderã€‘\nName: ${name}\nLINE: ${line}\n----------------\n`;
        for(let k in cart) {
            msg += `${k} x ${cart[k].qty} = $${cart[k].price * cart[k].qty}\n`;
        }
        msg += `----------------\nTotal: $${document.getElementById('total-price').innerText}`;
        
        location.href = `https://line.me/R/msg/text/?${encodeURIComponent(msg)}`;
    }
</script>

</body>
</html>