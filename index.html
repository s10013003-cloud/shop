<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰å’Šç™¾è²¨ç”Ÿæ´»é¤¨ - Join Home Supermarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --- å“ç‰Œè¦–è¦ºè¨­å®š --- */
        :root {
            --brand-green: #1e7847; /* å˜‰å’Šç¶  */
            --brand-bg: #fdfdf9;    /* æº«æš–ç±³ç™½èƒŒæ™¯ */
            --brand-text: #333;
        }
        body { background-color: var(--brand-bg); padding-bottom: 120px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: var(--brand-text); }
        
        /* é é¦– Header */
        .header { background-color: white; border-bottom: 3px solid var(--brand-green); padding: 15px 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo-container { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .logo-img { max-height: 70px; width: auto; object-fit: contain; } 
        .header-text h1 { margin: 0; font-size: 1.3rem; font-weight: bold; color: var(--brand-green); letter-spacing: 1px; }
        .header-text p { margin: 0; font-size: 0.8rem; color: #666; letter-spacing: 0.5px; }

        /* å•†å“å¡ç‰‡ */
        .product-card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.04); margin-bottom: 15px; background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: row; transition: transform 0.2s; }
        .product-card:active { transform: scale(0.98); }
        
        /* åœ–ç‰‡è¨­å®š */
        .product-img-box { width: 110px; height: 110px; flex-shrink: 0; position: relative; background: #eee; cursor: zoom-in; }
        .product-img { width: 100%; height: 100%; object-fit: cover; }
        .zoom-hint { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 0.7rem; padding: 2px 6px; border-top-left-radius: 6px; pointer-events: none; }

        /* å•†å“è³‡è¨Š */
        .product-info { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .product-name { font-weight: bold; font-size: 1rem; margin-bottom: 4px; color: #222; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .product-price { color: #e63946; font-weight: bold; font-size: 1.2rem; }
        
        /* åŠ æ¸›æŒ‰éˆ• */
        .qty-control { display: flex; align-items: center; background: #f1f3f5; border-radius: 20px; padding: 2px; }
        .qty-btn { width: 30px; height: 30px; border: none; background: white; border-radius: 50%; color: var(--brand-green); font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        .qty-btn:active { background: var(--brand-green); color: white; }
        .qty-val { width: 30px; text-align: center; font-weight: bold; font-size: 1rem; color: #333; }

        /* åº•éƒ¨çµå¸³å€ */
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 1000; border-top-left-radius: 16px; border-top-right-radius: 16px; }
        
        /* è¡¨å–®æ¨£å¼ */
        .form-control { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; margin-bottom: 10px; }
        .form-control:focus { background-color: white; border-color: var(--brand-green); box-shadow: none; }

        .btn-checkout { background-color: var(--brand-green); border: none; padding: 12px; font-size: 1.1rem; width: 100%; border-radius: 8px; box-shadow: 0 4px 10px rgba(30, 120, 71, 0.3); }
        .btn-checkout:hover { background-color: #16663b; }
        .btn-checkout:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }

        /* è®€å–å‹•ç•« */
        .loading { text-align: center; padding: 60px 20px; color: #888; }
        .spinner-border { width: 3rem; height: 3rem; border-width: 0.25em; }

        /* åœ–ç‰‡ç‡ˆç®± (Lightbox) */
        .lightbox-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease; }
        .lightbox-modal.show { opacity: 1; }
        .lightbox-content-wrapper { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; }
        .lightbox-img { max-width: 90%; max-height: 80vh; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s ease; }
        .lightbox-modal.show .lightbox-img { transform: scale(1); }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 35px; cursor: pointer; z-index: 2001; background: rgba(0,0,0,0.3); width: 50px; height: 50px; text-align: center; line-height: 46px; border-radius: 50%; }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-container">
        <img src="logo.jpg" alt="å˜‰å’Šç™¾è²¨ Logo" class="logo-img" onerror="this.style.display='none'">
        <div class="header-text">
            <h1>å˜‰å’Šç™¾è²¨ç”Ÿæ´»é¤¨</h1>
            <p>Join Home Supermarket</p>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div id="loading" class="loading">
        <div class="spinner-border text-success mb-3" role="status"></div>
        <p>æ­£åœ¨æ•´ç†è²¨æ¶ï¼Œè«‹ç¨å€™...</p>
    </div>
    
    <div id="product-list"></div>
</div>

<div id="imgLightbox" class="lightbox-modal" onclick="closeLightbox()">
    <div class="lightbox-close">&times;</div>
    <div class="lightbox-content-wrapper">
        <img class="lightbox-img" id="lightboxImg">
    </div>
</div>

<div class="cart-bar">
    <div id="checkout-form" style="display:none;">
        <div class="row g-2">
            <div class="col-4">
                <input type="text" class="form-control" id="cust-name" placeholder="æ‚¨çš„å§“å*">
            </div>
            <div class="col-4">
                <input type="tel" class="form-control" id="cust-phone" placeholder="é›»è©±è™Ÿç¢¼*">
            </div>
            <div class="col-4">
                <input type="text" class="form-control" id="cust-line" placeholder="LINE ID">
            </div>
        </div>
    </div>
    
    <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
            <div class="text-muted" style="font-size:0.9rem">è³¼ç‰©è»Š <span class="badge bg-secondary rounded-pill" id="cart-count">0</span> é …</div>
            <div class="fw-bold fs-4 text-success">$<span id="total-price">0</span></div>
        </div>
        <div style="width: 50%;">
            <button onclick="submitOrder()" class="btn btn-success fw-bold btn-checkout" id="btn-submit">
                ç¢ºèªä¸‹å–®
            </button>
        </div>
    </div>
</div>

<script>
    // =========================================================
    // è¨­å®šå€ (å·²å¡«å…¥æ‚¨çš„ç¶²å€)
    // =========================================================
    
    // å•†å“è³‡æ–™ä¾†æº
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRUuy3yndWvFJqQGIZ0oXiWDLjbYzOzZGK6DN1WPz6yExBiAGLZifNvJxvrxyfvjpN7H22qmwqujOkM/pub?gid=0&single=true&output=csv'; 

    // è¨‚å–®æ¥æ”¶å¾Œå°
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbySfQr-1oxCQPVaCRQMKoJSlPhigsUryAMWDnISiWQhC38XoDkfUZwg129FTGY1Na5LSQ/exec';
    
    // =========================================================

    let products = [];
    let cart = {};

    // ç¶²é è¼‰å…¥å¾ŒåŸ·è¡Œ
    window.onload = function() {
        fetch(csvUrl)
            .then(res => {
                if (!res.ok) throw new Error("ç„¡æ³•é€£çµè³‡æ–™åº«");
                return res.text();
            })
            .then(text => {
                products = parseCSV(text);
                renderProducts();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('checkout-form').style.display = 'block';
            })
            .catch(err => {
                document.getElementById('loading').innerHTML = `
                    <div class="text-danger fw-bold">âŒ è®€å–å¤±æ•—</div>
                    <small>è«‹ç¢ºèª Google è©¦ç®—è¡¨æ˜¯å¦å·²ç™¼å¸ƒç‚º CSV æ ¼å¼ã€‚</small>
                `;
                console.error(err);
            });
    };

    // è§£æ CSV
    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const result = [];
        // è·³éæ¨™é¡Œåˆ—ï¼Œå¾ç¬¬2è¡Œé–‹å§‹
        for(let i=1; i<lines.length; i++) {
            // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼è™•ç† CSV (é¿å…é€—è™Ÿå‡ºéŒ¯)
            const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(row && row.length >= 2) {
                const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : ''; 
                
                const name = clean(row[0]);
                const price = parseInt(clean(row[1])) || 0;
                const img = row[2] ? clean(row[2]) : '';

                if(name) { // åªè¦æœ‰åç¨±å°±é¡¯ç¤º
                     result.push({ id: i, name, price, img });
                }
            }
        }
        return result;
    }

    // ç•«é¢æ¸²æŸ“
    function renderProducts() {
        const list = document.getElementById('product-list');
        let html = '';
        
        if(products.length === 0) {
            list.innerHTML = '<div class="text-center text-muted py-5">ç›®å‰æ²’æœ‰å•†å“ä¸Šæ¶</div>';
            return;
        }

        products.forEach(p => {
            // åœ–ç‰‡è™•ç†ï¼šè‹¥ç„¡åœ–ç‰‡å‰‡ä½¿ç”¨é è¨­åœ–
            let imgSrc = (p.img && p.img.startsWith('http')) ? p.img : 'https://placehold.co/150x150/e9ecef/1e7847?text=å˜‰å’Š';
            let qty = cart[p.name] ? cart[p.name].qty : 0;

            html += `
            <div class="product-card">
                <div class="product-img-box" onclick="openLightbox('${imgSrc}')">
                    <img src="${imgSrc}" class="product-img" alt="${p.name}">
                    <div class="zoom-hint">ğŸ”</div>
                </div>
                <div class="product-info">
                    <div class="product-name">${p.name}</div>
                    <div class="d-flex justify-content-between align-items-end mt-2">
                        <span class="product-price">$${p.price}</span>
                        
                        <div class="qty-control">
                            <button onclick="updateQty('${p.name}', ${p.price}, -1)" class="qty-btn" ${qty===0?'disabled':''}>-</button>
                            <div class="qty-val">${qty}</div>
                            <button onclick="updateQty('${p.name}', ${p.price}, 1)" class="qty-btn">+</button>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    }

    // è³¼ç‰©è»Šé‚è¼¯
    function updateQty(name, price, change) {
        if (change === 1 && !cart[name]) {
            cart[name] = { price: price, qty: 1 };
        } else if (cart[name]) {
            cart[name].qty += change;
            if (cart[name].qty <= 0) delete cart[name];
        }
        renderProducts();
        updateCartTotal();
    }

    function updateCartTotal() {
        let total = 0, count = 0;
        for(let k in cart) {
            total += cart[k].price * cart[k].qty;
            count += cart[k].qty;
        }
        document.getElementById('total-price').innerText = total;
        document.getElementById('cart-count').innerText = count;
    }

    // --- ç‡ˆç®±åŠŸèƒ½ ---
    function openLightbox(src) {
        const modal = document.getElementById('imgLightbox');
        const img = document.getElementById('lightboxImg');
        img.src = src;
        modal.style.display = 'block';
        setTimeout(() => modal.classList.add('show'), 10);
    }
    
    function closeLightbox() {
        const modal = document.getElementById('imgLightbox');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    }

    // --- é€å‡ºè¨‚å–® ---
    function submitOrder() {
        const name = document.getElementById('cust-name').value.trim();
        const phone = document.getElementById('cust-phone').value.trim();
        const line = document.getElementById('cust-line').value.trim();
        const total = document.getElementById('total-price').innerText;
        
        // æª¢æŸ¥
        if(Object.keys(cart).length === 0) return alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼');
        if(!name || !phone) return alert('è«‹å¡«å¯«å§“åå’Œé›»è©±ï¼Œæ–¹ä¾¿æˆ‘å€‘è¯çµ¡æ‚¨ã€‚');

        // é–å®šæŒ‰éˆ•
        const btn = document.getElementById('btn-submit');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'è™•ç†ä¸­...';

        // æ•´ç†è¨‚å–®æ˜ç´°
        let details = '';
        for(let k in cart) {
            details += `${k} x${cart[k].qty} ($${cart[k].price*cart[k].qty}), `;
        }

        // æ‰“åŒ…è³‡æ–™
        const formData = new FormData();
        formData.append('å§“å', name);
        formData.append('é›»è©±', phone);
        formData.append('LINE_ID', line);
        formData.append('è¨‚å–®å…§å®¹', details);
        formData.append('ç¸½é‡‘é¡', total);

        // ç™¼é€åˆ° GAS
        fetch(scriptUrl, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    alert('âœ… è¨‚å–®å·²é€å‡ºï¼æˆ‘å€‘æœƒç›¡å¿«è™•ç†ã€‚');
                    // é‡ç½®
                    cart = {};
                    document.getElementById('cust-name').value = '';
                    document.getElementById('cust-phone').value = '';
                    document.getElementById('cust-line').value = '';
                    renderProducts();
                    updateCartTotal();
                } else {
                    alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + data.error);
                }
            })
            .catch(err => {
                alert('âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = originalText;
            });
    }
</script>

</body>
</html>