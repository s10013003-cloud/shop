<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰å’Šç™¾è²¨ç”Ÿæ´»é¤¨ - Join Home Supermarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* --- å“ç‰Œè¦–è¦º --- */
        :root {
            --brand-green: #1e7847;
            --brand-bg: #fdfdf5;
            --brand-text: #333;
        }
        body { background-color: var(--brand-bg); padding-bottom: 120px; font-family: Arial, sans-serif; color: var(--brand-text); }
        
        .header { background-color: var(--brand-bg); border-bottom: 4px solid var(--brand-green); padding: 15px 10px; text-align: center; }
        .logo-img { max-height: 80px; width: auto; display: block; margin: 0 auto 10px auto; } 
        
        .lang-select { max-width: 200px; margin: 0 auto; border: 2px solid var(--brand-green); color: var(--brand-green); font-weight: bold; border-radius: 20px; text-align: center; cursor: pointer; }

        .product-card { border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 15px; background: white; border-radius: 15px; overflow: hidden; display: flex; flex-direction: row; align-items: center; min-height: 120px; }
        
        /* åœ–ç‰‡å€åŸŸ - å¼·åˆ¶è¨­å®šå¤§å°èˆ‡èƒŒæ™¯ï¼Œé¿å…ç ´åœ–æ™‚å¤ªé›£çœ‹ */
        .product-img-box { width: 130px; height: 130px; flex-shrink: 0; background: #e9ecef; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .product-img { width: 100%; height: 100%; object-fit: cover; }
        .no-img-text { font-size: 0.7rem; color: #999; position: absolute; }

        .product-info { padding: 10px 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; height: 130px; }
        .product-name { font-weight: bold; font-size: 1.1rem; color: #222; margin-bottom: 2px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .product-subname { font-size: 0.85rem; color: #888; margin-bottom: auto; display: block; }
        
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .product-price { color: #e63946; font-weight: bold; font-size: 1.3rem; }
        
        .qty-control { display: flex; align-items: center; background: #f0f0f0; border-radius: 20px; padding: 2px 8px; }
        .qty-btn { width: 28px; height: 28px; border: none; background: white; border-radius: 50%; color: var(--brand-green); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
        .qty-val { width: 30px; text-align: center; font-weight: bold; font-size: 1rem; color: #333; }

        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 1000; border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .btn-checkout { background-color: var(--brand-green); border: none; padding: 12px; font-size: 1.1rem; width: 100%; border-radius: 10px; font-weight: bold; }

        /* ç‡ˆç®± */
        .lightbox-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); }
        .lightbox-content-wrapper { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; }
        .lightbox-img { max-width: 95%; max-height: 80vh; border-radius: 8px; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 40px; cursor: pointer; background: rgba(0,0,0,0.5); width: 50px; height: 50px; text-align: center; line-height: 45px; border-radius: 50%; }
    </style>
</head>
<body>

<div class="header">
    <img src="logo.jpg" alt="Logo" class="logo-img" onerror="this.style.display='none'">
    <select id="lang-switch" class="form-select lang-select" onchange="switchLang(this.value)">
        <option value="zh">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
        <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
    </select>
</div>

<div class="container mt-3">
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-success" role="status"></div>
        <div class="mt-2 text-muted">Reading data...</div>
    </div>
    <div id="product-list"></div>
    <div id="debug-msg" class="text-danger text-center mt-3" style="font-size:0.8rem;"></div>
</div>

<div id="imgLightbox" class="lightbox-modal" onclick="closeLightbox()">
    <div class="lightbox-close">&times;</div>
    <div class="lightbox-content-wrapper"><img class="lightbox-img" id="lightboxImg"></div>
</div>

<div class="cart-bar">
    <div id="checkout-form" style="display:none;">
        <div class="row g-2">
            <div class="col-4"><input type="text" class="form-control" id="cust-name" placeholder="Name"></div>
            <div class="col-4"><input type="tel" class="form-control" id="cust-phone" placeholder="Phone"></div>
            <div class="col-4"><input type="text" class="form-control" id="cust-line" placeholder="LINE ID"></div>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-2">
        <div>
            <div class="text-muted small">Cart: <span class="badge bg-secondary rounded-pill" id="cart-count">0</span></div>
            <div class="fw-bold fs-4 text-success">$<span id="total-price">0</span></div>
        </div>
        <div style="width: 50%;">
            <button onclick="submitOrder()" class="btn btn-success text-white btn-checkout" id="btn-submit">Checkout</button>
        </div>
    </div>
</div>

<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRUuy3yndWvFJqQGIZ0oXiWDLjbYzOzZGK6DN1WPz6yExBiAGLZifNvJxvrxyfvjpN7H22qmwqujOkM/pub?gid=0&single=true&output=csv'; 
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbySfQr-1oxCQPVaCRQMKoJSlPhigsUryAMWDnISiWQhC38XoDkfUZwg129FTGY1Na5LSQ/exec';

    let products = [];
    let cart = {};
    let currentLang = 'zh';

    const uiText = {
        zh: { name: "å§“å", phone: "é›»è©±", line: "LINE ID", btn: "ç¢ºèªä¸‹å–®", empty: "è³¼ç‰©è»Šæ˜¯ç©ºçš„" },
        en: { name: "Your Name", phone: "Phone", line: "LINE ID", btn: "Place Order", empty: "Cart is empty" },
        id: { name: "Nama", phone: "Nomor HP", line: "ID LINE", btn: "Pesan Sekarang", empty: "Keranjang kosong" },
        vi: { name: "TÃªn", phone: "Sá»‘ Ä‘iá»‡n thoáº¡i", line: "ID LINE", btn: "Äáº·t hÃ ng", empty: "Giá» hÃ ng trá»‘ng" }
    };

    window.onload = function() {
        fetch(csvUrl)
            .then(res => res.text())
            .then(text => {
                products = parseCSVSmart(text); // ä½¿ç”¨æ–°çš„æ™ºæ…§è§£æåŠŸèƒ½
                renderProducts();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('checkout-form').style.display = 'block';
            })
            .catch(err => {
                document.getElementById('loading').innerHTML = 'âŒ è®€å–å¤±æ•—';
                document.getElementById('debug-msg').innerText = 'è«‹æª¢æŸ¥ Google è©¦ç®—è¡¨é€£çµèˆ‡æ¬Šé™è¨­å®šã€‚\n' + err;
            });
    };

    // --- å¼·åŠ›åœ–ç‰‡è½‰æ›å™¨ (è§£æ±º Google Drive é¡¯ç¤ºå•é¡Œ) ---
    function fixImgUrl(url) {
        if (!url) return '';
        url = url.trim();
        // æŠ“å– Google Drive ID
        if (url.indexOf('drive.google.com') !== -1) {
            let id = '';
            // å˜—è©¦åŒ¹é… /d/ID/
            let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match) id = match[1];
            // å˜—è©¦åŒ¹é… id=ID
            if (!id) {
                match = url.match(/id=([a-zA-Z0-9_-]+)/);
                if (match) id = match[1];
            }
            // å¦‚æœæ‰¾åˆ° IDï¼Œè½‰æˆç›´æ¥é è¦½é€£çµ
            if (id) return `https://drive.google.com/uc?export=view&id=${id}`;
        }
        return url;
    }

    // --- æ™ºæ…§ CSV è§£æ (ä¸å†ä¾è³´é †åºï¼Œè€Œæ˜¯ä¾è³´æ¨™é¡Œ) ---
    function parseCSVSmart(text) {
        const lines = text.trim().split('\n');
        if (lines.length < 2) return [];

        // 1. è®€å–æ¨™é¡Œåˆ—ï¼Œæ‰¾å‡ºæ¯ä¸€æ¬„åœ¨å“ªå€‹ä½ç½®
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
        
        // å»ºç«‹ç´¢å¼•åœ°åœ– (ä¾‹å¦‚: name_zh åœ¨ç¬¬ 0 æ¬„, price åœ¨ç¬¬ 4 æ¬„...)
        const idx = {
            zh: headers.indexOf('name_zh'),
            en: headers.indexOf('name_en'),
            id: headers.indexOf('name_id'),
            vi: headers.indexOf('name_vi'),
            price: headers.indexOf('price'),
            img: headers.indexOf('img')
        };

        // å¦‚æœæ‰¾ä¸åˆ°é—œéµæ¬„ä½ï¼Œå ±éŒ¯
        if (idx.zh === -1 || idx.price === -1) {
            document.getElementById('debug-msg').innerText = 'âš ï¸ éŒ¯èª¤ï¼šè©¦ç®—è¡¨æ¨™é¡Œä¸æ­£ç¢ºã€‚\nè«‹ç¢ºèªç¬¬ä¸€åˆ—æœ‰: name_zh, name_en, name_id, name_vi, price, img';
            return [];
        }

        const result = [];
        for(let i=1; i<lines.length; i++) {
            // æ­£å‰‡è™•ç† CSV (è™•ç†é€—è™Ÿå…§å®¹)
            const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(row) {
                const clean = (colIndex) => {
                    if (colIndex === -1 || !row[colIndex]) return '';
                    return row[colIndex].replace(/^"|"$/g, '').trim();
                };

                const p = {
                    id: i,
                    zh: clean(idx.zh),
                    en: clean(idx.en),
                    id_lang: clean(idx.id),
                    vi: clean(idx.vi),
                    price: parseInt(clean(idx.price)) || 0,
                    img: fixImgUrl(clean(idx.img)) // ä½¿ç”¨å¼·åŠ›è½‰æ›
                };

                if (p.zh && p.price) result.push(p);
            }
        }
        return result;
    }

    function switchLang(lang) {
        currentLang = lang;
        const t = uiText[lang];
        document.getElementById('cust-name').placeholder = t.name;
        document.getElementById('cust-phone').placeholder = t.phone;
        document.getElementById('cust-line').placeholder = t.line;
        document.getElementById('btn-submit').innerText = t.btn;
        renderProducts();
    }

    function renderProducts() {
        const list = document.getElementById('product-list');
        let html = '';
        products.forEach(p => {
            // èªè¨€é‚è¼¯ï¼šè‹¥è©²èªè¨€ç©ºç™½ï¼Œå‰‡é¡¯ç¤ºä¸­æ–‡
            let mainName = p.zh;
            if (currentLang === 'en' && p.en) mainName = p.en;
            if (currentLang === 'id' && p.id_lang) mainName = p.id_lang;
            if (currentLang === 'vi' && p.vi) mainName = p.vi;
            
            // è‹¥ç‚ºå¤–æ–‡æ¨¡å¼ï¼Œå‰¯æ¨™é¡Œé¡¯ç¤ºä¸­æ–‡
            let subName = (currentLang !== 'zh') ? p.zh : '&nbsp;';
            
            // åœ–ç‰‡è™•ç†
            let imgHTML = p.img ? 
                `<img src="${p.img}" class="product-img" onerror="this.parentElement.innerHTML='<span class=\'no-img-text\'>No Image</span>'">` : 
                `<span class="no-img-text">No Image</span>`;

            let qty = cart[p.zh] ? cart[p.zh].qty : 0;

            html += `
            <div class="product-card">
                <div class="product-img-box" onclick="openLightbox('${p.img}')">
                    ${imgHTML}
                </div>
                <div class="product-info">
                    <div>
                        <div class="product-name">${mainName}</div>
                        <span class="product-subname">${subName}</span>
                    </div>
                    <div class="price-row">
                        <span class="product-price">$${p.price}</span>
                        <div class="qty-control">
                            <button onclick="updateQty('${p.zh}', ${p.price}, -1)" class="qty-btn">-</button>
                            <div class="qty-val">${qty}</div>
                            <button onclick="updateQty('${p.zh}', ${p.price}, 1)" class="qty-btn">+</button>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    }

    function updateQty(nameZh, price, change) {
        if (change === 1 && !cart[nameZh]) {
            cart[nameZh] = { price: price, qty: 1 };
        } else if (cart[nameZh]) {
            cart[nameZh].qty += change;
            if (cart[nameZh].qty <= 0) delete cart[nameZh];
        }
        renderProducts();
        updateCartTotal();
    }

    function updateCartTotal() {
        let total = 0, count = 0;
        for(let k in cart) {
            total += cart[k].price * cart[k].qty;
            count += cart[k].qty;
        }
        document.getElementById('total-price').innerText = total;
        document.getElementById('cart-count').innerText = count;
    }

    function openLightbox(src) {
        if(!src) return;
        document.getElementById('imgLightbox').style.display = 'block';
        document.getElementById('lightboxImg').src = src;
    }
    function closeLightbox() {
        document.getElementById('imgLightbox').style.display = 'none';
    }

    function submitOrder() {
        const name = document.getElementById('cust-name').value.trim();
        const phone = document.getElementById('cust-phone').value.trim();
        const line = document.getElementById('cust-line').value.trim();
        const total = document.getElementById('total-price').innerText;
        const t = uiText[currentLang];

        if(Object.keys(cart).length === 0) return alert(t.empty);
        if(!name || !phone) return alert(currentLang==='zh' ? 'è«‹å¡«å¯«å§“åå’Œé›»è©±' : 'Please fill in Name and Phone');

        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.innerText = 'Processing...';

        let details = '';
        for(let k in cart) {
            details += `${k} x${cart[k].qty}, `;
        }

        const formData = new FormData();
        formData.append('å§“å', name);
        formData.append('é›»è©±', phone);
        formData.append('LINE_ID', line);
        formData.append('è¨‚å–®å…§å®¹', details);
        formData.append('ç¸½é‡‘é¡', total);

        fetch(scriptUrl, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    alert('âœ… Order Sent Successfully!');
                    cart = {};
                    document.getElementById('cust-name').value = '';
                    document.getElementById('cust-phone').value = '';
                    renderProducts();
                    updateCartTotal();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => alert('Network Error'))
            .finally(() => {
                btn.disabled = false;
                btn.innerText = t.btn;
            });
    }
</script>

</body>
</html>